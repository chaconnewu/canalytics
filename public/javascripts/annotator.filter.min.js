/*
** Annotator 1.2.5-dev-b83d51d
** https://github.com/okfn/annotator/
**
** Copyright 2012 Aron Carroll, Rufus Pollock, and Nick Stenning.
** Dual licensed under the MIT and GPLv3 licenses.
** https://github.com/okfn/annotator/blob/master/LICENSE
**
** Built at: 2012-12-04 05:16:02Z
*/(function(){var e=function(e,t){return function(){return e.apply(t,arguments)}},t={}.hasOwnProperty,n=function(e,n){function i(){this.constructor=e}for(var r in n)t.call(n,r)&&(e[r]=n[r]);return i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype,e};Annotator.Plugin.Filter=function(t){function r(t,n){this._onPreviousClick=e(this._onPreviousClick,this),this._onNextClick=e(this._onNextClick,this),this._onFilterKeyup=e(this._onFilterKeyup,this),this._onFilterBlur=e(this._onFilterBlur,this),this._onFilterFocus=e(this._onFilterFocus,this),this.updateHighlights=e(this.updateHighlights,this);var i;t=$(this.html.element).appendTo((n!=null?n.appendTo:void 0)||this.options.appendTo),r.__super__.constructor.call(this,t,n),(i=this.options).filters||(i.filters=[]),this.filter=$(this.html.filter),this.filters=[],this.current=0}return n(r,t),r.prototype.events={".annotator-filter-property input focus":"_onFilterFocus",".annotator-filter-property input blur":"_onFilterBlur",".annotator-filter-property input keyup":"_onFilterKeyup",".annotator-filter-previous click":"_onPreviousClick",".annotator-filter-next click":"_onNextClick",".annotator-filter-clear click":"_onClearClick"},r.prototype.classes={active:"annotator-filter-active",hl:{hide:"annotator-hl-filtered",active:"annotator-hl-active"}},r.prototype.html={element:'<div class="annotator-filter">\n  <strong>'+Annotator._t("Navigate:")+'</strong>\n<span class="annotator-filter-navigation">\n  <button class="annotator-filter-previous">'+Annotator._t("Previous")+'</button>\n<button class="annotator-filter-next">'+Annotator._t("Next")+"</button>\n</span>\n<strong>"+Annotator._t("Filter by:")+"</strong>\n</div>",filter:'<span class="annotator-filter-property">\n  <label></label>\n  <input/>\n  <button class="annotator-filter-clear">'+Annotator._t("Clear")+"</button>\n</span>"},r.prototype.options={appendTo:"body",filters:[],addAnnotationFilter:!0,isFiltered:function(e,t){var n,r,i,s;if(!e||!t)return!1;s=e.split(/\s*/);for(r=0,i=s.length;r<i;r++){n=s[r];if(t.indexOf(n)===-1)return!1}return!0}},r.prototype.pluginInit=function(){var e,t,n,r;r=this.options.filters;for(t=0,n=r.length;t<n;t++)e=r[t],this.addFilter(e);this.updateHighlights(),this._setupListeners()._insertSpacer();if(this.options.addAnnotationFilter===!0)return this.addFilter({label:Annotator._t("Annotation"),property:"text"})},r.prototype._insertSpacer=function(){var e,t;return t=$("html"),e=parseInt(t.css("padding-top"),10)||0,t.css("padding-top",e+this.element.outerHeight()),this},r.prototype._setupListeners=function(){var e,t,n,r;t=["annotationsLoaded","annotationCreated","annotationUpdated","annotationDeleted"];for(n=0,r=t.length;n<r;n++)e=t[n],this.annotator.subscribe(e,this.updateHighlights);return this},r.prototype.addFilter=function(e){var t,n;n=$.extend({label:"",property:"",isFiltered:this.options.isFiltered},e);if(!function(){var e,r,i,s;i=this.filters,s=[];for(e=0,r=i.length;e<r;e++)t=i[e],t.property===n.property&&s.push(t);return s}.call(this).length)n.id="annotator-filter-"+n.property,n.annotations=[],n.element=this.filter.clone().appendTo(this.element),n.element.find("label").html(n.label).attr("for",n.id),n.element.find("input").attr({id:n.id,placeholder:Annotator._t("Filter by ")+n.label+"â€¦"}),n.element.find("button").hide(),n.element.data("filter",n),this.filters.push(n);return this},r.prototype.updateFilter=function(e){var t,n,r,i,s,o,u;e.annotations=[],this.updateHighlights(),this.resetHighlights(),r=$.trim(e.element.find("input").val());if(r){n=this.highlights.map(function(){return $(this).data("annotation")}),u=$.makeArray(n);for(s=0,o=u.length;s<o;s++)t=u[s],i=t[e.property],e.isFiltered(r,i)&&e.annotations.push(t);return this.filterHighlights()}},r.prototype.updateHighlights=function(){return this.highlights=this.annotator.element.find(".annotator-hl:visible"),this.filtered=this.highlights.not(this.classes.hl.hide)},r.prototype.filterHighlights=function(){var e,t,n,r,i,s,o,u,a,f;e=$.grep(this.filters,function(e){return!!e.annotations.length}),r=((f=e[0])!=null?f.annotations:void 0)||[],e.length>1&&(n=[],$.each(e,function(){return $.merge(n,this.annotations)}),o=[],r=[],$.each(n,function(){return $.inArray(this,o)===-1?o.push(this):r.push(this)})),i=this.highlights;for(s=u=0,a=r.length;u<a;s=++u)t=r[s],i=i.not(t.highlights);return i.addClass(this.classes.hl.hide),this.filtered=this.highlights.not(this.classes.hl.hide),this},r.prototype.resetHighlights=function(){return this.highlights.removeClass(this.classes.hl.hide),this.filtered=this.highlights,this},r.prototype._onFilterFocus=function(e){var t;return t=$(e.target),t.parent().addClass(this.classes.active),t.next("button").show()},r.prototype._onFilterBlur=function(e){var t;if(!e.target.value)return t=$(e.target),t.parent().removeClass(this.classes.active),t.next("button").hide()},r.prototype._onFilterKeyup=function(e){var t;t=$(e.target).parent().data("filter");if(t)return this.updateFilter(t)},r.prototype._findNextHighlight=function(e){var t,n,r,i,s,o,u,a;return this.highlights.length?(o=e?0:-1,a=e?-1:0,u=e?"lt":"gt",t=this.highlights.not("."+this.classes.hl.hide),r=t.filter("."+this.classes.hl.active),r.length||(r=t.eq(o)),n=r.data("annotation"),i=t.index(r[0]),s=t.filter(":"+u+"("+i+")").not(n.highlights).eq(a),s.length||(s=t.eq(a)),this._scrollToHighlight(s.data("annotation").highlights)):this},r.prototype._onNextClick=function(e){return this._findNextHighlight()},r.prototype._onPreviousClick=function(e){return this._findNextHighlight(!0)},r.prototype._scrollToHighlight=function(e){return e=$(e),this.highlights.removeClass(this.classes.hl.active),e.addClass(this.classes.hl.active),$("html, body").animate({scrollTop:e.offset().top-(this.element.height()+20)},150)},r.prototype._onClearClick=function(e){return $(e.target).prev("input").val("").keyup().blur()},r}(Annotator.Plugin)}).call(this);